<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 9.1.0" />
<title>Massive MapTool Server (MMS)</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overridden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(3);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Massive MapTool Server (MMS)</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>This project is an attempt to create a <em>MapTool</em> installation in which the
server password is not sufficient to connect to said server.</p></div>
<div class="paragraph"><p>This is accomplished by configuring an SSH server on the same system where
the <em>MapTool</em> server is running and using SSH&#8217;s built in port forwarding
capability to forward connections to the <em>MapTool</em> server.</p></div>
<div class="paragraph"><p>This moves the decision of who is allowed to connect to the SSH
configuration and not just the <em>MapTool</em> server&#8217;s "player password".</p></div>
<div class="paragraph"><p>A preconfigured virtual machine is available at <a href="https://www.eeconsulting.net/mms/Massive%20MapTool%20Server.ova">https://www.eeconsulting.net/mms/Massive%20MapTool%20Server.ova</a>.
If you want to use your own hosting platform, you&#8217;ll need to setup your own
virtual machine.
Notes on what I had to do to configure Ubuntu 18.04 are under <a href="#Setting Up a Virtual Machine from Scratch">[Setting Up a Virtual Machine from Scratch]</a></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_connection_set_up">Connection Set Up</h2>
<div class="sectionbody">
<div class="paragraph"><p>There are four steps.  The number in <a href="#Figure 1">[Figure 1]</a> refers to these step numbers.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Start the <em>MapTool</em> server
</p>
</li>
<li>
<p>
Start the <em>SSH</em> server (most systems do this automatically at boot)
</p>
</li>
<li>
<p>
Start the <em>SSH</em> client and enable connection tunneling
</p>
</li>
<li>
<p>
Start the <em>MapTool</em> client and connect to the tunnel
</p>
</li>
</ol></div>
<div class="literalblock">
<div class="title">Figure 1</div>
<div class="content">
<pre><code>┌─────────────────────────────┐             ┌──────────────────────────────┐
│                             │             │                              │
│   ┌─────────────────────┐   │             │   ┌──────────────────────┐   │
│   │                     │   │             │   │                      │   │
│   │  4. MapTool client  │   │             │   │  1. MapTool server   │   │
│   │                     │   │             │   │                      │   │
│   └──────────┬──────────┘   │             │   └──────────▲───────────┘   │
│              │              │             │              │               │
│              │              │             │              │               │
│              │ 4.           │             │              │ 4.            │
│              │              │             │              │               │
│              │              │             │              │               │
│   ┌──────────▼──────────┐   │      4.     │   ┌──────────┴───────────┐   │
│   │                     ├───┼─────────────┼───►                      │   │
│   │     3. SSH client   │   │      3.     │   │     2. SSH server    │   │
│   │                     ◄───┼─────────────┼───►                      │   │
│   └─────────────────────┘   │             │   └──────────────────────┘   │
│                             │             │                              │
└─────────────────────────────┘             └──────────────────────────────┘</code></pre>
</div></div>
<div class="sect2">
<h3 id="_step_1_start_the_em_maptool_em_server">Step 1: Start the <em>MapTool</em> Server</h3>
<div class="paragraph"><p>As shown in the diagram, the first step is to start the <em>MapTool</em> server.
Use whatever port you wish (here I&#8217;m going to use <em>srvrPort</em> as a placeholder).
Do NOT specify a value for the <em>RPTools Registry</em> field.
(The server is not going to be accessible to the public, so adding a name to the registry is nonsensical.)</p></div>
<div class="paragraph"><p>It would be ideal if <em>MapTool</em> could be forced to bind to only localhost, but that isn&#8217;t currently possible.
A workaround is to use a <em>srvrPort</em> that cannot be connected to from outside the server.
This can frequently be done by using firewall rules to block such connection attempts, or to configure the virtual machine&#8217;s network card in NAT mode.

(See the section below, <a href="#Running the VM Locally">[Running the VM Locally]</a>.)</p></div>
</div>
<div class="sect2">
<h3 id="_step_2_start_the_em_ssh_em_server">Step 2: Start the <em>SSH</em> Server</h3>
<div class="paragraph"><p>Once the <em>MapTool</em> server is running, start the <em>SSH</em> server daemon on the same system.
This will be performed as part of the bootup sequence of most systems and starting this daemon prior to <em>MapTool</em> is fine and will still work properly.</p></div>
<div class="paragraph"><p>This <em>SSH</em> server will accept connection requests from players and allow them to forward a local port on their end to the <em>MapTool</em> server port on the server.
Note that <em>SSH</em> cannot forward UDP traffic, but <em>MapTool</em> doesn&#8217;t need UDP anyway.</p></div>
</div>
<div class="sect2">
<h3 id="_step_3_start_em_ssh_em_on_the_player_system">Step 3: Start <em>SSH</em> on the Player System</h3>
<div class="paragraph"><p>The player starts their <em>SSH</em> client and tells it to forward a local port to the remote <em>MapTool</em> port.
I&#8217;m going to use <em>clntPort</em> to represent the local port, and <em>srvrIP</em> to represent the server&#8217;s IP address and/or hostname (either one will work, as hostnames are converted to IP addresses on the fly).</p></div>
<div class="sect3">
<h4 id="_unix_clients">Unix Clients</h4>
<div class="paragraph"><p>A typical Un*x command line on the client would look something like this:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>ssh -t -L localhost:clntPort:localhost:srvrPort maptool@srvrIP</code></pre>
</div></div>
<div class="paragraph"><p>In the above command line, <code>-t</code> enables creation of a pseudotty for the connection.
The server will require pseudottys in order to implement logging, but some <em>SSH</em> clients may not create them by default, thus this option is included.</p></div>
<div class="paragraph"><p>The <code>-L</code> option is how one specifies the local port and where it should be forwarded.
The string ``localhost:``<em>clntPort</em> says that the <em>SSH</em> client should listen on the given port on the local machine.
When a connection is made to that port, the request is forwarded across the encrypted link to the server.
The <em>SSH</em> daemon on the server will then connect to ``localhost:``<em>srvrPort</em> and transparently tunnel all traffic between the two end points.</p></div>
<div class="paragraph"><p>The last field specifies who to login as and what the server IP address is.</p></div>
<div class="paragraph"><p>Note that remote GMs can also connect using the above process.</p></div>
</div>
<div class="sect3">
<h4 id="_windows_clients">Windows Clients</h4>
<div class="paragraph"><p>Using something like <em>PuTTY</em>:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Start <em>PuTTY</em> and go into <strong>Settings</strong>.
</p>
</li>
<li>
<p>
Under <strong>Session</strong>, enter the IP address of the server into the <strong>Host name</strong> field.
</p>
</li>
<li>
<p>
Under <strong>Connection &#8594; Data</strong>, put <code>maptool</code> in the username field.
</p>
</li>
<li>
<p>
Under <strong>Connection &#8594; SSH</strong>, turn on the <strong>Don&#8217;t start a shell</strong> checkbox.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_start_em_maptool_em_on_the_player_system">Step 4: Start <em>MapTool</em> on the Player System</h3>
<div class="paragraph"><p>The last step is to start <em>MapTool</em> on the player&#8217;s system:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The player should open <em>MapTool</em> and choose <strong>File &#8594; Connect to Server&#8230;</strong>.
</p>
</li>
<li>
<p>
Fill in player name and player password as provided by the GM.
</p>
</li>
<li>
<p>
The port number should be filled in as <em>clntPort</em>.
This is <strong>not</strong> the port number that the <em>MapTool</em> server is listening to!
Instead, it&#8217;s the local port that <em>SSH</em> is going to tunnel over its connection.
</p>
</li>
<li>
<p>
Switch to the <strong>Direct</strong> tab and fill in <code>localhost</code> as the server name.
</p>
</li>
<li>
<p>
Click <strong>OK</strong> to connect.
</p>
</li>
</ol></div>
<div class="paragraph"><p><em>MapTool</em> will connect to ``localhost:``<em>clntPort</em> which will then be forwarded to the remote system which will connect to the <em>MapTool</em> server.</p></div>
<div class="paragraph"><p>Note that <em>clntPort</em> and <em>srvrPort</em> don&#8217;t have to be the same numbers.
It might seem appropriate to make them the same, but I would discourage that.
If an error occurs in the network connection, using different port numbers will make explicit where the problem occurred (local or remote) when the error is reported.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_clients_to_the_allowed_connection_list">Adding Clients to the Allowed Connection List</h2>
<div class="sectionbody">
<div class="paragraph"><p>You will want to perform this section once for each player and/or GM that
needs to connect.</p></div>
<div class="paragraph"><p>To add a player or GM to the allowed list:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Have the individual generate a public/private key pair.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The public key <strong>must</strong> be a single line of text, and it should contain three
fields:  the type of encryption, the key itself, and a comment field.
There are many utilities that can generate such a key, but the <em>PuTTY Key
Generator</em> works well on <em>Windows</em>.
img::[putty_key_generator.png]</p></div>
<div class="paragraph"><p>Unix systems should use <code>ssh-keygen</code> (specify the output filename to be an
unused filename so you don&#8217;t overwrite an existing key pair!).</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
They should send you the public key (email, text msg, Discord DM, whatever).
<strong>The private key must remain private!</strong>
If anyone else were to get their hands on the private key, they would be able
to impersonate this player.
If they think their key has been compromised, they should notify you asap so
you can delete the corresponding public key.
</p>
</li>
<li>
<p>
You should store the key in a file under <code>~/.ssh/player-keys</code>.
Pick a filename that lets you know which individual it came from.
You can use any characters that are valid in a filename on <em>Linux</em>, so even a
full email address could be used as the filename.
<strong>Very important:</strong>  the filename must end with <code>.pub</code> or it won&#8217;t be
recognized.
</p>
</li>
<li>
<p>
Execute the <code>~/.ssh/activate.sh</code> script.
That script will gather all of the player keys together into one file, with a
prefix on every line that is needed for the tunneling to work.
The name of each file will also be embedded on that line so the SSH server can
create a log of who logged in/out (which is why you want to pick a filename
that you can easily relate back to the player).
</p>
</li>
</ol></div>
<div class="paragraph"><p>The new player/GM is now ready to go.
They should perform the two client-based steps in the previous section,
connecting via <em>SSH</em> (step 3) and then running the <em>MapTool</em> client (step 4).</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_a_virtual_machine_from_scratch">Setting Up a Virtual Machine from Scratch</h2>
<div class="sectionbody">
<div class="paragraph"><p>I have provided an Ubuntu 18.04 system with <em>MapTool</em> 1.8.5 installed and <em>SSH</em> already configured.</p></div>
<div class="paragraph"><p>However, you may want to set up and use your own virtual machine.
These are the steps required to get Ubuntu up and running; your distribution may require some modification of these steps&#8201;&#8212;&#8201;or even additional ones&#8201;&#8212;&#8201;so use these as guide, but feel free to tweak them.</p></div>
<div class="paragraph"><p>Prerequisites:</p></div>
<div class="ulist"><ul>
<li>
<p>
Ubuntu (tested with 18.04, and the "minimal" installation)
</p>
</li>
<li>
<p>
<em>MapTool</em> (tested with 1.8.5)
</p>
</li>
<li>
<p>
openssh-server
</p>
</li>
<li>
<p>
pandoc (only to convert this AsciiDoc file into HTML or another format)
</p>
</li>
</ul></div>
<div class="paragraph"><p>The username is <strong>maptool</strong>, and the password is <strong>maptool</strong> (yeah, <em>real</em> secure, huh?).
You&#8217;ll also see a username <code>franke</code> which is a testing account for me; that will go away and be replaced with something like <code>admin</code> in a future version.</p></div>
<div class="paragraph"><p>Several locations under <code>~/.ssh</code> are used for various public key management functions.
A quick overview is given here.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<code>player-keys/</code> - This subdirectory contains the public keys for all players.
The name of the file with <code>.pub</code> removed is the "username" that will show up in the MMS login file (currently not enabled).
These files are copied from the output created by <code>ssh-keygen</code>.
It is expected that the players will generate their own keys and send the public one to the VM administrator for inclusion in this directory.
(I&#8217;m unsure of the process on Windows to generate such keys since I don&#8217;t use Windows, but I&#8217;m sure the <em>PuTTY</em> suite of software tools can do it because my brother has done it for a project we collaborated on.)
Filenames must be unique, so the VM administrator should ensure that when storing the files.
</p>
</li>
<li>
<p>
<code>setup.sh</code> - This script sets up some environment variables and changes to the <code>~/.ssh</code> directory.
It is for internal use only.
</p>
</li>
<li>
<p>
<code>activate.sh</code> - This script collects all public keys under <code>player-keys</code> and creates the <code>authorized_keys</code> file used by the SSH server.
</p>
</li>
<li>
<p>
<code>mt-serve</code> - This is the script automatically executed when a player connects as <code>maptool</code> to the <em>MapTool</em> server.
It uses the <code>REMOTE</code> environment variable created in the <code>authorized_keys</code> file to identify the player name for logging purposes (not related to the name used in <em>MapTool</em> for the player).
It requires that ptys be enabled; from the command line that means adding the <code>-t</code> as documented above, but we&#8217;ll need to figure out the option for this on Windows.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Other scripts are part of a work-in-progress to create a menu system that helps automate management of the public keys.</p></div>
<div class="sect2">
<h3 id="_ssh_server_configuration">SSH Server Configuration</h3>
<div class="literalblock">
<div class="content">
<pre><code>LoginGraceTime 30
UsePAM yes
PermitUserEnvironment yes

Match User maptool
        # This is the player name assigned by the GM
        AcceptEnv REMOTE
        AllowAgentForwarding no
        AllowStreamLocalForwarding no
        AllowTcpForwarding yes
        AuthenticationMethods publickey
        ClientAliveCountMax 3
        ClientAliveInterval 60
        ForceCommand ~/.ssh/mt-serve
        KbdInteractiveAuthentication no
        # 100 simultaneous login sessions
        MaxSessions 100
        PasswordAuthentication no
        # Only allow remote ports to be forwarded to local ports on this host
        PermitOpen localhost:*
        PermitTTY yes
        PermitUserRC no
        # Already turned on, but just in case it's turned off in the main file
        PubkeyAuthentication yes
        X11Forwarding no</code></pre>
</div></div>
<div class="paragraph"><p>The above will let you use password authentication for accounts other than <strong>maptool</strong>.
If you want everything to be done through public keys, add this line above the <code>Match</code> block:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>PasswordAuthentication no</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_network_settings_for_the_virtual_machine">Network Settings for the Virtual Machine</h3>
<div class="paragraph"><p>All that&#8217;s left is to configure the network for the VM.
This section potentially has a lot of options, depending on how you want to run things.
I will describe what I think are the two most common setups:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Running the VM with a network card set to <strong>NAT</strong>.
</p>
</li>
<li>
<p>
Running the VM with a network card set to <strong>Bridged</strong>.
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="_running_the_vm_locally">Running the VM Locally</h4>
<div class="paragraph"><p>For this, you only need a single network card configured inside the VM.
That network card has two options that are probably the most useful:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>Bridged</strong> - (Recommended) This option puts the guest VM onto your local LAN, just as though it were another physical machine connected to the same router.
It will contact your router and be assigned a dynamic IP address automatically (assuming your router is running a DHCP service, which it likely is):
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Open the <strong>Settings</strong> for the VM.
</p>
</li>
<li>
<p>
Click on the <strong>Network</strong> tab.
</p>
</li>
<li>
<p>
Configure the first network card to be <code>Bridged</code>.
</p>
</li>
<li>
<p>
No other <em>VirtualBox</em> configuration is necessary.
</p>
</li>
</ol></div>
</li>
<li>
<p>
<strong>NAT</strong> - This prevents all inbound connection requests by default, but you can configure port forwarding to the VM via the <em>VirtualBox</em> configuration panel:
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Open the <strong>Settings</strong> for the VM.
</p>
</li>
<li>
<p>
Click on the <strong>Network</strong> tab.
</p>
</li>
<li>
<p>
Configure the first network card to be <code>NAT</code>.
</p>
</li>
<li>
<p>
Click to expand the <strong>Advanced</strong> section.
</p>
</li>
<li>
<p>
Click the <strong>Port Forwarding&#8230;</strong> button.
</p>
</li>
<li>
<p>
Add a new port forwarding rule that directs some local port on your host system to a particular port inside the guest VM.
For example, host port <code>12345</code> might be directed to <code>51234</code> inside the guest.
Now, any attempt to talk to <code>12345</code> on your system will automatically be routed into the guest VM, including connection attempts from outside the host operating system.
You can test this by start the MapTool server inside the guest, then starting a client on your desktop.
Choose <strong>File &#8594; Connect to Server&#8230;</strong> and use the <strong>Direct</strong> tab to fill in <code>localhost</code> and port number <code>12345</code>.
Your connection should work.
</p>
</li>
</ol></div>
</li>
</ol></div>
<div class="paragraph"><p>There are options other than the two above.
For example, I frequently use two network cards in my VMs, one which is configured for NAT that is used for communicating to the outside world, and a second one set to Host-only so that I can easily connect from the host OS to the guest without needing port forwarding.
These advanced network configurations are not covered here.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_download_and_install_maptool_inside_the_vm">Download and Install MapTool Inside the VM</h3>
<div class="paragraph"><p>From inside the VM, visit <a href="https://github.com/RPTools/maptool/releases">https://github.com/RPTools/maptool/releases</a> and download the release you wish to use.
Install the application.
Current builds put the installation under <code>/opt/maptool</code> and the executable is in <code>/opt/maptool/bin/MapTool</code>.</p></div>
<div class="paragraph"><p>It may be convenient to start MapTool directly from a desktop icon.
To do that, copy the file that comes with MapTool into your local desktop icons list:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>cp /opt/maptool/lib/*.desktop ~/.local/share/applications</code></pre>
</div></div>
<div class="paragraph"><p>This also integrates it into Ubuntu&#8217;s desktop search function.
(Other distributions likely have a different destination for the copy.)
This means you can click the <strong>Show Applications</strong> button and type <code>map</code> to see the MapTool icon and execute it.</p></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2021-06-17 22:22:32 EDT
</div>
</div>
</body>
</html>
